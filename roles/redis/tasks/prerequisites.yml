---
- name: Verify prerequisites
  assert:
    that:
      - redis_password != "changeme"
      - redis_data_dir is defined
      - redis_port is defined
    fail_msg: "Required variables not properly configured"

- name: Create Redis directories
  ansible.builtin.file:
    path: "{{ redis_data_dir }}/{{ item }}"
    state: directory
    mode: "0750"
  loop:
    - ""  # Base directory
    - config
    - data

- name: Template Redis configuration
  ansible.builtin.template:
    src: redis.conf.j2
    dest: "{{ redis_data_dir }}/config/redis.conf"
    mode: "0640"

- name: Configure SELinux for Redis directories
  when: ansible_os_family == "RedHat" and ansible_selinux.status == "enabled"
  become: true
  block:
    - name: Set SELinux context for Redis directories
      ansible.builtin.sefcontext:
        target: "{{ redis_data_dir }}(/.*)?"
        setype: container_file_t
        state: present

    - name: Apply SELinux context
      ansible.builtin.command: restorecon -R -v "{{ redis_data_dir }}"
      register: restorecon_result
      changed_when: restorecon_result.rc == 0