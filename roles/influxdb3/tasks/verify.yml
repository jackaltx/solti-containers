---
#
# Verify InfluxDB3 deployment
# This is run via: ./svc-exec.sh influxdb3 verify
#

# ...................................................................................
- name: Verify InfluxDB3 pod is running
  command: podman pod ps --format {% raw %}"{{.Name}}"{% endraw %}
  register: pod_status
  failed_when: "'influxdb3' not in pod_status.stdout"
  changed_when: false

- name: Show pod status
  debug:
    var: pod_status.stdout_lines

# ...................................................................................
- name: Verify InfluxDB3 containers are running
  command: podman ps --format {% raw %}"{{.Names}}"{% endraw %} --filter "pod=influxdb3"
  register: container_status
  changed_when: false

- name: Show container status
  debug:
    var: container_status.stdout_lines

# ...................................................................................
- name: Wait for InfluxDB3 to be ready
  command: >
    podman exec influxdb3-svc
    curl -s http://localhost:{{ influxdb3_internal_port }}/health
  register: health_check
  until: health_check.rc == 0
  retries: 30
  delay: 5
  changed_when: false

- name: Show health status
  debug:
    var: health_check.stdout

# ...................................................................................
# Load admin token for tests
- name: Load admin token for verification
  block:
    - name: Check if admin token file exists
      ansible.builtin.stat:
        path: "{{ influxdb3_data_dir }}/config/admin-token.txt"
      register: token_file_check

    - name: Read admin token file
      ansible.builtin.slurp:
        src: "{{ influxdb3_data_dir }}/config/admin-token.txt"
      register: encoded_token
      when: token_file_check.stat.exists

    - name: Set admin token
      ansible.builtin.set_fact:
        verify_token: "{{ encoded_token.content | b64decode | trim }}"
      # no_log: true
      when: token_file_check.stat.exists

    - name: Fail if no token available
      ansible.builtin.fail:
        msg: "No admin token found. Please run deploy first."
      when: not token_file_check.stat.exists

# ...................................................................................
# Create test database
- name: Create test database
  command: >
    podman exec
    -e INFLUXDB3_AUTH_TOKEN={{ verify_token }}
    influxdb3-svc influxdb3 create database test-ansible
  register: test_db
  changed_when: test_db.rc == 0
  failed_when:
    - test_db.rc != 0
    - "'already exists' not in test_db.stderr"
  # no_log: true

# ...................................................................................
# Write test data
- name: Write test data point
  command: >
    podman exec influxdb3-svc
    curl -s -X POST "http://localhost:{{ influxdb3_internal_port }}/api/v3/write?db=test-ansible"
    -H "Authorization: Bearer {{ verify_token }}"
    --data-binary "test_measurement,host={{ ansible_hostname }} value=123,status=\"ok\" {{ ansible_date_time.epoch }}000000000"
  register: write_result
  changed_when: false
  # no_log: true

- name: Show write result
  debug:
    msg: "Test data written successfully"
  when: write_result.rc == 0

# ...................................................................................
# Query test data
- name: Query test data
  command: >
    podman exec influxdb3-svc
    curl -s "http://localhost:{{ influxdb3_internal_port }}/api/v3/query?db=test-ansible&q=SELECT%20*%20FROM%20test_measurement"
    -H "Authorization: Bearer {{ verify_token }}"
  register: query_result
  changed_when: false
  # no_log: true

- name: Show query result
  debug:
    var: query_result.stdout_lines

# ...................................................................................
# Cleanup test database
- name: Delete test database
  command: >
    podman exec
    -e INFLUXDB3_AUTH_TOKEN={{ verify_token }}
    influxdb3-svc influxdb3 delete database test-ansible
  changed_when: false
  failed_when: false
  # no_log: true

# ...................................................................................
- name: Display verification summary
  debug:
    msg:
      - "=============================================================="
      - "InfluxDB3 verification complete!"
      - "✓ Pod running"
      - "✓ Container running"
      - "✓ API responding"
      - "✓ Database operations working"
      - "✓ Write operations working"
      - "✓ Query operations working"
      - "=============================================================="
