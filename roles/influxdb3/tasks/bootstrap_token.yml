---
#
# Bootstrap InfluxDB3 admin token
# This task generates the admin token if it doesn't exist
#

# ....................................................................................
- name: Check if admin token file exists inside container
  become: false
  ansible.builtin.command:
    cmd: podman exec influxdb3-svc test -f /var/lib/influxdb3/secrets/admin-token
  register: token_check
  failed_when: false
  changed_when: false

# ....................................................................................
- name: Bootstrap admin token
  when: token_check.rc != 0
  block:
    - name: Generate admin token from container
      become: false
      ansible.builtin.command:
        cmd: podman exec influxdb3-svc influxdb3 create token --admin
      register: token_output
      changed_when: true

    - name: Extract token from output
      ansible.builtin.set_fact:
        admin_token: "{{token_output.stdout | regex_search('apiv3_[A-Za-z0-9_-]+')}}"

    - name: Verify token was extracted
      ansible.builtin.fail:
        msg: "Failed to extract valid token from output"
      when: admin_token is not defined or admin_token == "" or not admin_token.startswith('apiv3_')

    - name: Save token to secrets directory inside container
      become: false
      ansible.builtin.shell:
        cmd: |
          echo "{{admin_token}}" | podman exec -i influxdb3-svc tee /var/lib/influxdb3/secrets/admin-token > /dev/null
      changed_when: true

    - name: Save token to config directory for reference
      become: false
      ansible.builtin.copy:
        content: "{{admin_token}}"
        dest: "{{influxdb3_data_dir}}/config/admin-token.txt"
        mode: '0600'

    - name: Verify token is valid (query token list)
      become: false
      ansible.builtin.command:
        cmd: >
          podman exec influxdb3-svc
          influxdb3 show tokens --format json --token {{admin_token}}
      register: token_verify
      changed_when: false
      failed_when: token_verify.rc != 0

    - name: Display token creation result
      ansible.builtin.debug:
        msg: "Admin token generated, saved, and verified"
        verbosity: 0

    - name: Restart InfluxDB3 to load new token
      become: false
      ansible.builtin.systemd:
        name: "{{service_properties.name}}"
        state: restarted
        scope: user

    - name: Wait for InfluxDB3 to be ready after token creation
      ansible.builtin.wait_for:
        host: 127.0.0.1
        port: "{{influxdb3_port}}"
        timeout: 120

# ....................................................................................
- name: Display token location
  when: token_check.rc != 0
  ansible.builtin.debug:
    msg: |
      Admin token saved to:
      - Inside container: /var/lib/influxdb3/secrets/admin-token
      - Reference copy: {{influxdb3_data_dir}}/config/admin-token.txt
      - Container volume mount: {{influxdb3_secrets_dir}}/admin-token
    verbosity: 0
