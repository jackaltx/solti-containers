---
# check_upgrade_container.yml - Check single container for updates
# Called by check_upgrade.yml for each container in pod
# Expects: container_info (format: "name|image")

- name: Parse container info
  set_fact:
    container_name: "{{ container_info.split('|')[0] }}"
    container_image: "{{ container_info.split('|')[1] }}"

- name: Get current container image ID
  command: >
    podman inspect {{ container_name }} --format '{% raw %}{{.Image}}{% endraw %}'
  register: current_image_id
  changed_when: false

- name: Get current image creation time
  command: >
    podman image inspect {{ current_image_id.stdout }} --format '{% raw %}{{.Created}}{% endraw %}'
  register: current_created
  changed_when: false

- name: Pull latest image from registry
  command: >
    podman pull {{ container_image }}
  register: pull_result
  changed_when: "'Copying blob' in pull_result.stderr or 'Copying config' in pull_result.stderr"
  failed_when: false

- name: Get latest image ID
  command: >
    podman image inspect {{ container_image }} --format '{% raw %}{{.Id}}{% endraw %}'
  register: latest_image_id
  changed_when: false

- name: Get latest image creation time
  command: >
    podman image inspect {{ container_image }} --format '{% raw %}{{.Created}}{% endraw %}'
  register: latest_created
  changed_when: false

- name: Display container status
  debug:
    msg: "{{ status_msg }}"
  vars:
    upgrade_available: "{{ current_image_id.stdout != latest_image_id.stdout }}"
    status_msg: >-
      {{ container_name }}:
      {%- if upgrade_available -%}
      UPDATE AVAILABLE - Current: {{ current_image_id.stdout[:12] }} ({{ current_created.stdout[:10] }}) | Latest: {{ latest_image_id.stdout[:12] }} ({{ latest_created.stdout[:10] }})
      {%- else -%}
      Up to date ({{ current_image_id.stdout[:12] }})
      {%- endif -%}

- name: Collect result
  set_fact:
    container_checks: "{{ container_checks | default([]) + [check_result] }}"
  vars:
    check_result:
      container_name: "{{ container_name }}"
      container_image: "{{ container_image }}"
      upgrade_available: "{{ current_image_id.stdout != latest_image_id.stdout }}"
      current_image_id: "{{ current_image_id.stdout }}"
      latest_image_id: "{{ latest_image_id.stdout }}"
      current_created: "{{ current_created.stdout }}"
      latest_created: "{{ latest_created.stdout }}"
