---
# check_upgrade.yml - Check if container image updates are available
# Generic pattern that discovers all containers in pod
# Usage: ./svc-exec.sh -h <host> -i inventory/<host>.yml <service> check_upgrade

- name: Get all containers in pod
  command: >
    podman ps --filter "pod={{ service_properties.root }}" --format '{% raw %}{{.Names}}|{{.Image}}{% endraw %}'
  register: pod_containers
  changed_when: false
  failed_when: pod_containers.rc != 0

- name: Display discovered containers
  debug:
    msg: "Found {{ pod_containers.stdout_lines | length }} container(s) in pod: {{ service_properties.root }}"

- name: Check each container for updates
  include_tasks: check_upgrade_container.yml
  loop: "{{ pod_containers.stdout_lines }}"
  loop_control:
    loop_var: container_info
  when: "'infra' not in container_info"  # Skip pause/infra container

- name: Summary of upgrade status
  debug:
    msg: "{{ upgrade_summary }}"
  vars:
    upgrade_summary: >-
      {%- set updates = [] -%}
      {%- for result in container_checks | default([]) -%}
        {%- if result.upgrade_available -%}
          {%- set _ = updates.append(result.container_name) -%}
        {%- endif -%}
      {%- endfor -%}
      {%- if updates | length > 0 -%}
      UPDATES AVAILABLE for: {{ updates | join(', ') }}
      {%- else -%}
      All containers up to date
      {%- endif -%}
