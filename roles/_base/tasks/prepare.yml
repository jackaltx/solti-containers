---
# ....................................................................................
- name: Validate required variables in _base
  assert:
    that:
      - service_properties.data_dir is defined and service_properties.data_dir != ""
      - service_properties.config_dir is defined and service_properties.config_dir != ""
      - service_properties.dirs | length > 0
    fail_msg: |
      Required variables not properly configured:
      - service_properties.data_dir: Containers configuration directory
      - service_properties.config_dir: Containers configuration directory
      - service_properties.dirs: List of required directories

# ....................................................................................
# All rootless containers should use user-owned directories
- name: Create service directories (user ownership for rootless containers)
  become: false
  ansible.builtin.file:
    path: "{{ service_properties.data_dir }}{{ '/' + item.path if item.path != '' else '' }}"
    state: directory
    mode: "{{ item.mode }}"
    owner: "{{ real_user }}"
    group: "{{ real_user }}"
  loop: "{{ service_properties.dirs }}"

# ....................................................................................
- name: Configure SELinux if enabled
  become: true
  when:
    - ansible_facts.selinux.status is defined
    - ansible_facts.selinux.status == 'enabled'
  block:
    - name: Set SELinux context for service directories
      ansible.builtin.sefcontext:
        target: "{{ service_properties.data_dir }}(/.*)?"
        setype: container_file_t
        state: present
      register: sefcontext_result
      failed_when: false

    - name: Apply SELinux context
      ansible.builtin.command: restorecon -R -v "{{ service_properties.data_dir }}"
      register: restorecon_result
      changed_when: restorecon_result.rc == 0
      failed_when: false

    - name: Fallback - use chcon if semanage/restorecon fails
      ansible.builtin.command: chcon -R -t container_file_t "{{ service_properties.data_dir }}"
      when: sefcontext_result.failed or restorecon_result.rc != 0
      register: chcon_result
      changed_when: chcon_result.rc == 0
      failed_when: false
