---
#
# wazuh role - DEPRECATED
# Only 'absent' state is supported for cleanup
# This role is no longer maintained or tested

- name: Validate state parameter (deprecated - only absent allowed)
  ansible.builtin.fail:
    msg: |
      DEPRECATED: wazuh role is no longer maintained.
      Only 'absent' state is supported for cleanup.
      Current value: {{ wazuh_state }}
  when: wazuh_state != 'absent'

- name: Test become capability
  ansible.builtin.command: whoami
  register: become_test
  changed_when: false

# Get real user info using environment variables (immune to become)
- name: Get real user info from environment
  set_fact:
    real_user: "{{ lookup('env', 'USER') }}"
    real_user_dir: "{{ lookup('env', 'HOME') }}"
    real_user_uid: "{{ lookup('pipe', 'id -u') }}"

# =======================================================================
# PREPARATION (one-time setup)
# =======================================================================

- name: Prepare wazuh (one-time setup)
  when: wazuh_state == 'prepare'
  block:
    - name: Check if already prepared
      ansible.builtin.stat:
        path: "{{ wazuh_data_dir }}"
      register: data_dir_check

    - name: Fail if already prepared
      ansible.builtin.fail:
        msg: "wazuh appears to be already prepared. Directory {{ wazuh_data_dir }} exists."
      when: data_dir_check.stat.exists

    # ............................................................
    - name: Base prepare
      ansible.builtin.include_tasks:
        file: ../_base/tasks/prepare.yml

    # Moving Certificates to prepare for now

    - name: Include certificate tasks
      ansible.builtin.include_tasks: certificates.yml
      when: wazuh_generate_certs | bool

# =======================================================================
# DEPLOYMENT  (PRIVILEGED!!)
# =======================================================================

- name: Install Wazuh
  when: wazuh_state == 'present'
  become: true
  block:
    - name: Verify password is not default
      ansible.builtin.fail:
        msg: |
          WAZUH_ADMIN_PASSWORD must be set and not default. Either:
          1. Set wazuh_admin_password in your playbook
          2. Set WAZUH_ADMIN_PASSWORD environment variable
      when: >
        (wazuh_admin_password | default('')) == 'changeme'

    - name: Verify required directories exist
      become: true
      ansible.builtin.stat:
        path: "{{ wazuh_data_dir }}/{{ service_properties.config_dir }}"
      register: config_dir_check
      failed_when: not config_dir_check.stat.exists
      changed_when: false

    - name: Include prerequisites tasks
      ansible.builtin.include_tasks: prerequisites.yml

    - name: Include create user/role tasks
      ansible.builtin.include_tasks: generate-users.yml

    - name: Ensure network setup
      ansible.builtin.include_tasks:
        file: "../_base/tasks/networks.yml"

    - name: Include container tasks
      ansible.builtin.include_tasks: quadlet_privileged.yml

    - name: Wait for services to start
      ansible.builtin.pause:
        seconds: 30
        prompt: "Waiting for Wazuh services to start..."

    - name: Include post-setup tasks
      ansible.builtin.include_tasks: post_setup.yml

# =======================================================================
# CLEANUP
# =======================================================================

- name: Remove Wazuh
  when: wazuh_state == 'absent'
  become: true
  block:
    # ...............................................................................
    - name: Include cleanup tasks
      ansible.builtin.include_tasks:
        file: "../_base/tasks/cleanup.yml"
      vars:
        service_state: absent
