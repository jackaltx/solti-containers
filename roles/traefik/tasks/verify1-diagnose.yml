---
# Simple debug version to understand API structure
# Usage: ./svc-exec.sh traefik verify

# ..................................................................................
# Basic Container Health
# ..................................................................................
- name: Verify Traefik pod is running
  command: podman pod ps --format {% raw %}"{{.Name}}"{% endraw %}
  register: pod_status
  failed_when: "'traefik' not in pod_status.stdout"
  changed_when: false

- name: Show pod status
  debug:
    var: pod_status.stdout_lines

- name: Verify Traefik container is running
  command: podman ps --format {% raw %}"{{.Names}}"{% endraw %} --filter "pod=traefik"
  register: container_status
  failed_when: "'traefik' not in container_status.stdout"
  changed_when: false

- name: Show container status
  debug:
    var: container_status.stdout_lines

# ..................................................................................
# API Health Check
# ..................................................................................
- name: Test Traefik API accessibility
  uri:
    url: "http://localhost:{{traefik_dashboard_port}}/api/version"
    method: GET
    status_code: 200
    timeout: 10
  register: api_version
  ignore_errors: true

- name: Display API status
  debug:
    msg:
      - "ğŸŒ API Status: {{'âœ… ONLINE' if api_version.status == 200 else 'âŒ OFFLINE'}}"
      - "ğŸ“ Dashboard: http://localhost:{{traefik_dashboard_port}}"
      - "ğŸ”§ Version: {{api_version.json.Version if api_version.json is defined else 'Unknown'}}"

# ..................................................................................
# Get Raw API Data for Debugging
# ..................................................................................
- name: Get all HTTP routers (raw)
  uri:
    url: "http://localhost:{{traefik_dashboard_port}}/api/http/routers"
    method: GET
    status_code: 200
  register: routers_raw
  when: api_version.status == 200
  ignore_errors: true

- name: Debug routers data structure
  debug:
    msg: |
      ğŸ” ROUTERS API RESPONSE TYPE: {{routers_raw.json | type_debug}}
      ğŸ“Š ROUTERS COUNT: {{routers_raw.json | length if routers_raw.json is iterable else 'not iterable'}}
      ğŸ—‚ï¸ FIRST ROUTER KEYS: {{routers_raw.json[0].keys() | list if routers_raw.json and routers_raw.json | length > 0 else 'no routers'}}
  when: routers_raw.json is defined

- name: Get all HTTP services (raw)
  uri:
    url: "http://localhost:{{traefik_dashboard_port}}/api/http/services"
    method: GET
    status_code: 200
  register: services_raw
  when: api_version.status == 200
  ignore_errors: true

- name: Debug services data structure
  debug:
    msg: |
      ğŸ” SERVICES API RESPONSE TYPE: {{services_raw.json | type_debug}}
      ğŸ“Š SERVICES COUNT: {{services_raw.json | length if services_raw.json is iterable else 'not iterable'}}
      ğŸ—‚ï¸ FIRST SERVICE KEYS: {{services_raw.json[0].keys() | list if services_raw.json and services_raw.json | length > 0 else 'no services'}}
  when: services_raw.json is defined

- name: Get entrypoints (raw)
  uri:
    url: "http://localhost:{{traefik_dashboard_port}}/api/entrypoints"
    method: GET
    status_code: 200
  register: entrypoints_raw
  when: api_version.status == 200
  ignore_errors: true

- name: Debug entrypoints data structure
  debug:
    msg: |
      ğŸ” ENTRYPOINTS API RESPONSE TYPE: {{entrypoints_raw.json | type_debug}}
      ğŸ“Š ENTRYPOINTS: {{entrypoints_raw.json.keys() | list if entrypoints_raw.json is mapping else entrypoints_raw.json | length if entrypoints_raw.json is iterable else 'not iterable'}}
  when: entrypoints_raw.json is defined

# ..................................................................................
# Simple Routing Display
# ..................................................................................
- name: Display Simple Routing Info
  debug:
    msg: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘                        ğŸš¦ TRAEFIK ROUTING SUMMARY                             â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      ğŸ“ Dashboard: http://localhost:{{traefik_dashboard_port}}
      ğŸŒ Domain: {{domain}}
      ğŸ”— Network: {{service_network}}

      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ ğŸ“Š DISCOVERED ROUTES                                                            â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      {%- if routers_raw.json is defined and routers_raw.json | length > 0 %}
      {%- for router in routers_raw.json %}
      {%- if not router.name.startswith('api@') and not router.name.startswith('dashboard@') %}

      ğŸ”€ {{router.name}}
         ğŸ“ Rule: {{router.rule | default('No rule')}}
         ğŸ¯ Service: {{router.service | default('No service')}}
         ğŸ”’ TLS: {{'âœ… Yes' if router.tls else 'âŒ No'}}
      {%- endif %}
      {%- endfor %}
      {%- else %}
      âŒ No routers found or API unavailable
      {%- endif %}

      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ âš™ï¸ BACKEND SERVICES                                                              â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      {%- if services_raw.json is defined and services_raw.json | length > 0 %}
      {%- for service in services_raw.json %}
      {%- if not service.name.startswith('api@') and not service.name.startswith('dashboard@') %}

      âš™ï¸ {{service.name}}
         ğŸ’š Status: {{service.status | default('unknown')}}
         {%- if service.loadBalancer is defined and service.loadBalancer.servers is defined %}
         ğŸ–¥ï¸ Servers: {{service.loadBalancer.servers | length}}
         {%- endif %}
      {%- endif %}
      {%- endfor %}
      {%- else %}
      âŒ No services found or API unavailable
      {%- endif %}

# ..................................................................................
# Network and Certificate Status
# ..................................................................................
- name: Check network configuration
  command: podman network inspect {{service_network}}
  register: network_info
  changed_when: false
  ignore_errors: true

- name: Check ACME certificates
  stat:
    path: "{{traefik_data_dir}}/acme/acme.json"
  register: acme_file

- name: Display final summary
  debug:
    msg: |
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ ğŸ“‹ STATUS SUMMARY                                                               â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

      ğŸ¯ Traefik: {{'âœ… RUNNING' if api_version.status == 200 else 'âŒ DOWN'}}
      ğŸŒ Network: {{'âœ… EXISTS' if network_info.rc == 0 else 'âŒ MISSING'}}
      ğŸ”’ Certificates: {{'âœ… CONFIGURED' if acme_file.stat.exists else 'âŒ NOT FOUND'}}
      ğŸ“Š Routes: {{routers_raw.json | length if routers_raw.json is defined else 0}}
      âš™ï¸ Services: {{services_raw.json | length if services_raw.json is defined else 0}}

      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ ğŸ”§ USEFUL COMMANDS                                                              â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

      # View dashboard:
      open http://localhost:{{traefik_dashboard_port}}

      # Check raw API data:
      curl http://localhost:{{traefik_dashboard_port}}/api/http/routers | jq .
      curl http://localhost:{{traefik_dashboard_port}}/api/http/services | jq .

      # Monitor logs:
      podman logs -f traefik-svc
