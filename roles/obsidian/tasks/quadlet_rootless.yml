---
# Step 1: Create pod quadlet
- name: Create Obsidian pod Quadlet
  become: false
  containers.podman.podman_pod:
    name: obsidian
    state: quadlet
    dns: "{{ service_dns_servers }}"
    dns_search: "{{ service_dns_search }}"
    network: "{{ service_network }}"
    quadlet_dir: "{{ real_user_dir }}/.config/containers/systemd"
    ports:
      - "127.0.0.1:{{ obsidian_port }}:3000"
      - "127.0.0.1:{{ obsidian_https_port }}:3001"
    quadlet_options:
      - |
        [Service]
        Restart=always
      - |
        [Install]
        WantedBy=default.target

# Step 2: Create Obsidian container
- name: Create Obsidian container Quadlet
  become: false
  containers.podman.podman_container:
    name: obsidian-svc
    pod: obsidian.pod
    image: "{{ obsidian_image }}"
    state: quadlet
    quadlet_dir: "{{ real_user_dir }}/.config/containers/systemd"
    volume:
      - "{{ obsidian_data_dir }}/config:/config:Z"
      - "{{ obsidian_data_dir }}/vaults:/vaults:Z"
      - "{{ obsidian_data_dir }}/config/custom-cont-init.d:/custom-cont-init.d:Z,ro"
    env:
      PUID: "{{ obsidian_puid }}"
      PGID: "{{ obsidian_pgid }}"
      TZ: "{{ obsidian_tz }}"
      CUSTOM_ARGS: "{{ obsidian_custom_args }}"
      KEYBOARD_LAYOUT: "en-us-qwerty"
    shm_size: "1gb"
    security_opt:
      - "seccomp=unconfined"
    cap_add:
      - "SYS_ADMIN"
    label:
      traefik.enable: "{{ obsidian_enable_traefik | lower }}"
      traefik.http.routers.obsidian.rule: "Host(`{{ obsidian_svc_name | default('obsidian') }}.{{ domain }}`)"
      traefik.http.services.obsidian.loadbalancer.server.port: "3000"
    quadlet_options:
      - |
        [Unit]
        Description=Obsidian Note-Taking Application
        After=network-online.target
      - |
        [Service]
        Restart=always
        TimeoutStartSec=300
        TimeoutStopSec=70

# Step 3: Reload systemd and start
- name: Reload systemd user daemon
  ansible.builtin.shell: |
    export XDG_RUNTIME_DIR=/run/user/{{ real_user_uid }}
    systemctl --user daemon-reload
  become: false
  changed_when: false

- name: Start rootless pod with systemd
  ansible.builtin.shell: |
    export XDG_RUNTIME_DIR=/run/user/{{ real_user_uid }}
    systemctl --user start {{ service_properties.name }}
  become: false
  changed_when: true

- name: Wait for container to be ready
  ansible.builtin.wait_for:
    port: "{{ obsidian_port }}"
    delay: 5
    timeout: 60
