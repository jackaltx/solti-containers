---
# .......................................................................
- name: Verify prerequisite variables
  assert:
    that:
      - grafana_admin_password != "changeme"
      - grafana_data_dir is defined
      - grafana_port is defined
    fail_msg: "Required variables not properly configured"

# .......................................................................
# Get container user mapping first
- name: Get directory ownership
  ansible.builtin.stat:
    path: "{{grafana_data_dir}}/config"
  register: dir_info

- name: Debug ownership
  ansible.builtin.debug:
    msg: "uid: {{dir_info.stat.uid}}, gid: {{dir_info.stat.gid}}"

# .......................................................................
- name: Become root and configure settings
  become: true
  block:
    # ...................................................
    - name: Template Grafana configuration
      template:
        src: grafana.ini.j2
        dest: "{{grafana_data_dir}}/config/grafana.ini"
        mode: "0640"
        owner: "{{dir_info.stat.uid}}"
        group: "{{dir_info.stat.gid}}"
      notify: restart grafana

    # ...................................................
    # This is an interesting idea.
    # Claude: Lets create a task list to place datasources and dashboards
    # from this type of structure
    #
    # grafana_provision:
    #   datasource:
    #     - "http://monitor11.example.com:8086"
    #     - "http://jokester.example.com:3100"
    #   dashboard:
    #     - fleur_http   #  refs to a json file
    #     - fleur_mailsvc
    #     - linux_details
    #
    # - name: Create default datasource provisioning
    #   ansible.builtin.copy:
    #     dest: "{{grafana_data_dir}}/provisioning/datasources/default.yaml"
    #     content: |
    #       apiVersion: 1

    #       datasources:
    #         - name: Prometheus
    #           type: prometheus
    #           access: proxy
    #           url: http://localhost:9090
    #           isDefault: true
    #           editable: true
    #     mode: "0640"
    #     owner: "{{dir_info.stat.uid}}"
    #     group: "{{dir_info.stat.gid}}"

    # ...................................................
    # Note: SELinux configuration is handled by _base/tasks/prepare.yml
