---
# roles/minio/tasks/get_minio_secrets.yml
# HashiVault integration for MinIO credentials

# This task file is called when use_vault is enabled
# It retrieves MinIO credentials from HashiVault

- name: Retrieve MinIO root credentials from HashiVault
  set_fact:
    minio_root_user: "{{lookup('community.hashi_vault.hashi_vault', 'secret=secret/data/minio:root_user validate_certs=false url=' + vault_host + ':' + vault_port|string + ' token=' + vault_token) | default(lookup('env', 'MINIO_ROOT_USER') | default('minioadmin'))}}"
    minio_root_password: "{{lookup('community.hashi_vault.hashi_vault', 'secret=secret/data/minio:root_password validate_certs=false url=' + vault_host + ':' + vault_port|string + ' token=' + vault_token) | default(lookup('env', 'MINIO_ROOT_PASSWORD') | default('changeme'))}}"
  no_log: true
  when: vault_token != ''
  ignore_errors: true

- name: Warn if HashiVault credentials not available
  debug:
    msg: "Warning: HashiVault integration enabled but credentials not retrieved. Using fallback credentials."
  when:
    - vault_token == '' or minio_root_user is not defined
