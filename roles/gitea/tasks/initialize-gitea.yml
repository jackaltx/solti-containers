---
# gitea/tasks/initialize-gitea.yml
# Initialize Gitea with admin user via CLI

# ....................................................................................
# Verify Gitea is running and accessible
- name: Wait for Gitea to be ready
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ gitea_port }}"
    method: GET
    status_code: 200
  register: ping_result
  until: ping_result.status == 200
  retries: 30
  delay: 5

- name: Wait for database to be writable
  become: false
  ansible.builtin.command:
    cmd: podman exec --user git gitea-svc test -w /data/gitea/gitea.db
  register: db_writable
  until: db_writable.rc == 0
  retries: 10
  delay: 3
  failed_when: false
  changed_when: false

- name: Show Gitea status
  ansible.builtin.debug:
    msg: "Gitea is accessible at http://127.0.0.1:{{ gitea_port }}"

# ....................................................................................
# Check if any users exist in the database (not just our specific admin)
- name: Check if Gitea has any users
  become: false
  ansible.builtin.command:
    cmd: >
      podman exec --user git gitea-svc
      gitea admin user list
  register: user_list
  failed_when: false
  changed_when: false

- name: Parse user count
  ansible.builtin.set_fact:
    has_users: "{{ user_list.stdout_lines | length > 2 }}"

# ....................................................................................
# Check if admin user exists by trying to authenticate
- name: Check if admin user exists
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ gitea_port }}/api/v1/user"
    method: GET
    user: "{{ gitea_admin_user }}"
    password: "{{ gitea_admin_password }}"
    force_basic_auth: true
    status_code: [200, 401]
  register: admin_check
  failed_when: false

# ....................................................................................
# Create admin user using gitea CLI (run as git user, not root)
# Only create if:
#   1. Users exist (imported database) AND our admin user doesn't authenticate -> skip (imported users exist)
#   2. No users exist -> create our admin user (fresh install)
#   3. Our admin user exists -> skip (already initialized)
- name: Create admin user via gitea CLI
  become: false
  ansible.builtin.shell:
    cmd: |
      podman exec --user git gitea-svc \
        gitea admin user create \
        --admin \
        --username "{{ gitea_admin_user }}" \
        --password '{{ gitea_admin_password }}' \
        --email "{{ gitea_admin_email }}" \
        --must-change-password=false
  register: admin_create
  when:
    - admin_check.status == 401
    - not has_users
  failed_when:
    - admin_create.rc != 0
    - "'user already exists' not in admin_create.stderr"
    - "'user already exists' not in admin_create.stdout"
  changed_when: admin_create.rc == 0

- name: Fix password for existing admin user (if creation was skipped)
  become: false
  ansible.builtin.shell:
    cmd: |
      podman exec --user git gitea-svc \
        gitea admin user change-password \
        --username "{{ gitea_admin_user }}" \
        --password '{{ gitea_admin_password }}'
  register: password_change
  when:
    - admin_check.status == 401
    - has_users
  failed_when: false
  changed_when: password_change.rc == 0

- name: Display admin creation result
  ansible.builtin.debug:
    msg: >-
      {% if admin_check.status == 200 %}
      Admin user already exists and authenticated successfully
      {% elif has_users %}
      Existing users found (imported database) - skipping admin creation
      {% elif admin_create.changed %}
      Admin user created successfully
      {% else %}
      Admin user already exists
      {% endif %}
  when: admin_check.status == 401 or admin_check.status == 200

# ....................................................................................
# Verify admin user can authenticate (only if we just created it or it already existed)
- name: Verify admin user authentication
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ gitea_port }}/api/v1/user"
    method: GET
    user: "{{ gitea_admin_user }}"
    password: "{{ gitea_admin_password }}"
    force_basic_auth: true
    status_code: 200
  register: auth_verify
  retries: 3
  delay: 2
  when: not has_users or admin_check.status == 200

- name: Display authenticated user info
  ansible.builtin.debug:
    msg:
      - "Admin user authenticated successfully"
      - "Username: {{ auth_verify.json.login }}"
      - "Email: {{ auth_verify.json.email }}"
      - "Admin: {{ auth_verify.json.is_admin }}"
  when: auth_verify is defined and auth_verify.status is defined

# ....................................................................................
# Display completion message - imported database scenario
- name: Display initialization summary (imported database)
  ansible.builtin.debug:
    msg:
      - "===================================="
      - "Gitea Initialization Complete"
      - "===================================="
      - "Imported database detected with existing users."
      - "The configured admin user ({{ gitea_admin_user }}) was not created."
      - "Please log in with your existing admin credentials."
      - "===================================="
  when: has_users and admin_check.status == 401

# Display completion message - fresh install scenario
- name: Display initialization summary (fresh install)
  ansible.builtin.debug:
    msg:
      - "===================================="
      - "Gitea Initialization Complete"
      - "===================================="
      - "Admin user: {{ gitea_admin_user }}"
      - "Access URL: http://127.0.0.1:{{ gitea_port }}"
      - "Traefik URL: {{ gitea_root_url }}"
      - ""
      - "You can now log in with:"
      - "  Username: {{ gitea_admin_user }}"
      - "  Password: (the password you configured)"
      - "===================================="
  when: not has_users or admin_check.status == 200
