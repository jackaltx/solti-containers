---
# Deploy gitea using Podman Quadlets
# Single container with SQLite

# ....................................................
- name: Ensure systemd user directories exist
  become: false
  ansible.builtin.file:
    path: "{{ real_user_dir }}/{{ item }}"
    state: directory
    mode: "0755"
    owner: "{{ real_user }}"
    group: "{{ real_user }}"
  loop:
    - .config/systemd/user
    - .config/containers/systemd
    - .config/containers/systemd/env

# ....................................................
- name: Copy gitea environment file
  become: false
  ansible.builtin.copy:
    src: "{{ gitea_data_dir }}/config/gitea.env"
    dest: "{{ real_user_dir }}/.config/containers/systemd/env/gitea.env"
    mode: "0640"
    owner: "{{ real_user }}"
    group: "{{ real_user }}"
    remote_src: true

# ....................................................
- name: Check if timezone files exist
  ansible.builtin.stat:
    path: "{{ item }}"
  register: tz_files
  loop:
    - /etc/timezone
    - /etc/localtime

- name: Build volume list
  ansible.builtin.set_fact:
    gitea_volumes:
      - "{{ gitea_data_dir }}/data:/data:Z,U"
      - "{{ gitea_data_dir }}/config/app.ini:/data/gitea/conf/app.ini:Z,U"

- name: Add timezone volume if it exists
  ansible.builtin.set_fact:
    gitea_volumes: "{{ gitea_volumes + ['/etc/timezone:/etc/timezone:ro'] }}"
  when: tz_files.results[0].stat.exists

- name: Add localtime volume if it exists
  ansible.builtin.set_fact:
    gitea_volumes: "{{ gitea_volumes + ['/etc/localtime:/etc/localtime:ro'] }}"
  when: tz_files.results[1].stat.exists

# ....................................................
- name: Create gitea pod quadlet
  become: false
  containers.podman.podman_pod:
    name: gitea
    state: quadlet
    dns: "{{ service_dns_servers }}"
    dns_search: "{{ service_dns_search }}"
    network: "{{ service_network }}"
    quadlet_dir: "{{ real_user_dir }}/.config/containers/systemd"
    ports:
      - "127.0.0.1:{{ gitea_port }}:3000"
      - "127.0.0.1:{{ gitea_ssh_port }}:22"
    quadlet_options:
      - "[Unit]"
      - "Description=Gitea Pod"
      - "After=network-online.target"
      - ""
      - "[Service]"
      - "Restart=always"
      - ""
      - "[Install]"
      - "WantedBy=default.target"

- name: Create gitea container quadlet
  become: false
  containers.podman.podman_container:
    name: gitea-svc
    pod: gitea.pod
    image: "{{ gitea_image }}"
    state: quadlet
    quadlet_dir: "{{ real_user_dir }}/.config/containers/systemd"
    volume: "{{ gitea_volumes }}"
    env_file:
      - "{{ real_user_dir }}/.config/containers/systemd/env/gitea.env"
    env:
      USER_UID: "1000"
      USER_GID: "1000"
    label:
      traefik.enable: "{{ gitea_enable_traefik | lower }}"
      traefik.http.routers.gitea.rule: "Host(`{{ gitea_fqdn }}`)"
      traefik.http.routers.gitea.entrypoints: "websecure"
      traefik.http.routers.gitea.service: "gitea"
      traefik.http.services.gitea.loadbalancer.server.port: "3000"
      traefik.http.routers.gitea.middlewares: "secHeaders@file"
    quadlet_options:
      - "[Unit]"
      - "Description=Gitea Service Container"
      - "After=network-online.target"
      - ""
      - "[Service]"
      - "Restart=always"
      - "TimeoutStartSec=300"
      - "TimeoutStopSec=70"
      - ""
      - "[Install]"
      - "WantedBy=default.target"

# ....................................................................................
- name: Wait a moment for quadlet to be written
  ansible.builtin.wait_for:
    timeout: 10

# .......................................................................................
- name: reload systemd user daemon
  ansible.builtin.shell: |
    export XDG_RUNTIME_DIR=/run/user/{{ real_user_uid }}
    systemctl --user daemon-reload
  become: false
  changed_when: false

# .......................................................................................
- name: Start rootless pod with systemd
  ansible.builtin.shell: |
    export XDG_RUNTIME_DIR=/run/user/{{ real_user_uid }}
    systemctl --user start {{ service_properties.name }}
  become: false
  changed_when: true
